// Nextflow Configuration
// This configuration supports both local (macOS) and HPC (SLURM) execution

// Default parameters
params {
    // Pipeline parameters
    samples_csv = 'samples.csv'
    outdir = 'results'

    // Resource limits
    max_cpus = 4
    max_memory = '16.GB'
    max_time = '24.h'
}

// Process configuration - applies to all profiles
process {
    // Error handling
    errorStrategy = 'retry'
    maxRetries = 2

    // Default resources for all processes
    cpus = 1
    memory = '4.GB'
    time = '2.h'

    // Process-specific resource allocations
    withLabel: 'basic' {
        cpus = 1
        memory = '2.GB'
        time = '1.h'
    }

    withLabel: 'download' {
        cpus = 1
        memory = '2.GB'
        time = '4.h'
    }

    withLabel: 'fasterq_dump' {
        cpus = 4
        memory = '8.GB'
        time = '6.h'
    }

    withLabel: 'fastp' {
        cpus = 4
        memory = '8.GB'
        time = '2.h'
    }

    withLabel: 'bwa_index' {
        cpus = 4
        memory = '8.GB'
        time = '4.h'
    }

    withLabel: 'bwa_mem' {
        cpus = 4
        memory = '16.GB'
        time = '8.h'
    }

    withLabel: 'samsort' {
        cpus = 4
        memory = '16.GB'
        time = '4.h'
    }

    withLabel: 'markdups' {
        cpus = 4
        memory = '16.GB'
        time = '4.h'
    }

    withLabel: 'gatk' {
        cpus = 4
        memory = '16.GB'
        time = '8.h'
    }

    withLabel: 'mpileup' {
        cpus = 2
        memory = '8.GB'
        time = '4.h'
    }

    withLabel: 'varscan' {
        cpus = 2
        memory = '8.GB'
        time = '4.h'
    }
}

// Execution profiles
profiles {

    // Local macOS execution
    standard {
        process {
            executor = 'local'
        }
    }

    // Docker profile for local execution with containers
    docker {
        docker {
            enabled = true
            runOptions = '-u $(id -u):$(id -g)'
        }

        process {
            executor = 'local'
            shell = ['/bin/bash', '-euo', 'pipefail']

            // Bioinformatics containers
            withLabel: 'basic' {
                container = 'broadinstitute/gatk:latest'
            }

            withLabel: 'download' {
                container = 'debian:bullseye-slim'
            }

            withLabel: 'fasterq_dump' {
                container = 'staphb/sra-tools:3.0.0'
            }

            withLabel: 'fastp' {
                container = 'biocontainers/fastp:v0.23.4-1'
            }

            withLabel: 'bwa_index|bwa_mem|samsort|markdups' {
                container = 'broadinstitute/gatk:latest'
            }

            withLabel: 'gatk' {
                container = 'broadinstitute/gatk:latest'
            }

            withLabel: 'mpileup' {
                container = 'biocontainers/samtools:v1.17-0'
            }

            withLabel: 'varscan' {
                container = 'biocontainers/varscan:v2.4.4-1'
            }
        }
    }

    // HPC SLURM execution
    slurm {
        process {
            executor = 'slurm'
            queue = 'general'  // Change to your HPC queue name
            clusterOptions = '--account=your_account'  // Set your account

            // Use scratch directory for temp files
            scratch = '$SLURM_SCRATCH'

            // Module system will be used via script directives
            beforeScript = 'module purge'
        }

        // Increase resources for HPC
        process {
            withLabel: 'fasterq_dump' {
                cpus = 16
                memory = '64.GB'
                time = '12.h'
            }

            withLabel: 'bwa_mem' {
                cpus = 16
                memory = '64.GB'
                time = '24.h'
            }

            withLabel: 'samsort' {
                cpus = 16
                memory = '64.GB'
                time = '8.h'
            }

            withLabel: 'gatk' {
                cpus = 8
                memory = '32.GB'
                time = '24.h'
            }
        }
    }

    // Test profile with minimal resources
    test {
        process {
            executor = 'local'

            withLabel: '.*' {
                cpus = 1
                memory = '2.GB'
                time = '30.m'
            }
        }
    }
}

// Reporting and execution options
report {
    enabled = true
    file = "${params.outdir}/reports/execution_report.html"
}

timeline {
    enabled = true
    file = "${params.outdir}/reports/timeline.html"
}

trace {
    enabled = true
    file = "${params.outdir}/reports/trace.txt"
}

dag {
    enabled = true
    file = "${params.outdir}/reports/pipeline_dag.html"
}

// Manifest
manifest {
    name = 'GATK Somatic Variant Calling Pipeline'
    author = 'David'
    description = 'Nextflow pipeline for somatic variant calling with tumor-normal pairs'
    mainScript = 'main.nf'
    version = '1.0.0'
    nextflowVersion = '>=21.04.0'
}
